image: python:3.9

stages:
  - test
  - release
  - deploy

variables:
  POSTGRES_PASSWORD: password

test:
  services:
    - postgres:14.1
  cache:
    key:
      files:
        - poetry.lock
      prefix: ${CI_JOB_NAME}
    paths:
      - venv
      - .cache/pip
  stage: test
  script:
    - python -m venv venv
    - . venv/bin/activate
    - make dev-deps
    - make lint
    - alembic-autogen-check
    - make migrate
    - make test


